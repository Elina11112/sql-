Общие показатели
SELECT 
    o.status,
    COUNT(*) AS order_count,
    ROUND(100.0 * COUNT(*) / SUM(COUNT(*)) OVER (), 2) AS percent_total -- счет процентов
FROM orders o
JOIN customers c ON O.customer_id = c.customer_id 
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
WHERE o.status IN ('Completed', 'Cancelled', 'Returned')
GROUP BY o.status;



-- Финансовые метрики 

SELECT 
  c.city,
  p.category,
  SUM(oi.quantity * p.price) AS gross_amount,   -- общая сумма 
  SUM(oi.quantity * p.price) * SUM(1 - discount) AS net_amount -- общее количество 
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
JOIN orders o ON o.order_id = oi.order_id
JOIN customers c ON O.customer_id = c.customer_id 
GROUP BY c.city, p.category  

 -- Найдите топ-5 клиентов по общей выручке (net_amount) 
SELECT 
    c.customer_id,
    c.full_name,
    SUM(oi.quantity * p.price * (1 - oi.discount)) AS total_revenue
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
GROUP BY c.customer_id, c.full_name 
ORDER BY total_revenue DESC
LIMIT 5;

-- Посчитайте общую выручку по городам и по категориям
SELECT 
    c.city,
    p.category,
    SUM(oi.quantity * p.price) AS gross_amount, 
    SUM(oi.quantity * p.price * (1 - oi.discount)) AS  net_amount
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
GROUP BY c.city, p.category -- групирорвка по городу и категории 
ORDER BY  net_amount DESC;



-- Поведение покупателей 
--Какой способ оплаты приносит больше всего выручки?  
SELECT 
    o.payment_method,
    SUM(oi.quantity * p.price * (1 - oi.discount)) AS net_amount
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
GROUP BY o.payment_method -- группировка по методу оплаты 
ORDER BY net_amount DESC
LIMIT 1;


-- В какой категории товаров наибольшая средняя скидка?  
SELECT 
p.category,
ROUND(AVG(oi.discount) * 100, 2) AS avg_discount_percent
FROM order_items oi
JOIN products p ON oi.product_id = p.product_id
GROUP BY p.category
ORDER BY avg_discount_percent DESC

-- В каком городе самый высокий средний чек (AOV = сумма / кол-во заказов)?
SELECT 
    c.city,
    ROUND(SUM(oi.quantity * p.price * (1 - oi.discount)) / COUNT(DISTINCT o.order_id), 2) AS avg_order_value
FROM orders o
JOIN customers c ON o.customer_id = c.customer_id
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
GROUP BY c.city
ORDER BY avg_order_value DESC


--Временной анализ
--1. Отобразите помесячную динамику продаж за 2025 год (только Completed).  

SELECT 
    strftime('%Y-%m', o.order_date) AS month,
    SUM(oi.quantity * p.price * (1 - oi.discount)) AS net_amount
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
WHERE o.status = 'Completed'
  AND strftime('%Y', o.order_date) = '2025'
GROUP BY month
ORDER BY month

--В какой день недели совершается больше всего продаж?  
SELECT 
    strftime('%w', o.order_date) AS weekday,  -- 0 = воскресенье, 1 = понедельник и т.д.
    SUM(oi.quantity * p.price * (1 - oi.discount)) AS net_amount
FROM orders o
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id
WHERE o.status = 'Completed'
GROUP BY weekday
ORDER BY net_amount DESC;


-- Сравните выручку по способам оплаты: Card vs Online.
SELECT 
  o.status,
  SUM(oi.quantity * p.price * (1 - oi.discount)) AS net_amount
FROM orders o 
JOIN order_items oi ON o.order_id = oi.order_id
JOIN products p ON oi.product_id = p.product_id 
WHERE o.payment_method IN ('Card', 'Online')
GROUP BY o.payment_method
